<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Vocab Master - æœ€ç»ˆå®Œç¾ç‰ˆ</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="image_bank.js"></script>

    <style>
        /* === 1. åŸºç¡€ç³»ç»Ÿæ ·å¼ === */
        :root {
            --primary-color: #4A90E2;
            --primary-gradient: linear-gradient(135deg, #4A90E2 0%, #007AFF 100%);
            --secondary-bg: #F5F7FA;
            --text-main: #1D1D1F;
            --text-sub: #86868B;
            --success-color: #34C759;
            --error-color: #FF3B30;
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background-color: var(--secondary-bg); 
            margin: 0; padding: 0; height: 100vh; overflow: hidden; 
            color: var(--text-main);
        }
        
        #app { 
            width: 100%; max-width: 450px; background: #fff; margin: 0 auto;
            height: 100vh; display: flex; flex-direction: column; 
            position: relative; overflow: hidden; 
            box-shadow: 0 0 20px rgba(0,0,0,0.05);
        }

        .page-container { display: flex; flex-direction: column; height: 100%; overflow: hidden; }
        .scroll-wrapper { flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; background: #F9FAFC; display: flex; flex-direction: column;}

        /* === 2. é¡¶éƒ¨å¯¼èˆª === */
        .header-bar { 
            height: 50px; display: flex; align-items: center; padding: 0 15px; 
            border-bottom: 1px solid #f0f0f0; background: #fff; z-index: 100; flex-shrink: 0; 
        }
        .btn-back { background: none; border: none; font-size: 16px; color: #666; cursor: pointer; display: flex; align-items: center; font-weight: 500; }
        .page-title { margin-left: auto; margin-right: auto; font-weight: bold; transform: translateX(-15px); }

        /* === 3. ä¸»é¡µ UI (Heroæ ·å¼) === */
        .home-container { padding: 30px 20px; display: flex; flex-direction: column; align-items: center; height: 100%; overflow-y: auto; background: #fff; }
        .app-title { font-size: 28px; font-weight: 800; color: var(--text-main); margin-bottom: 25px; letter-spacing: 1px; }
        .app-title span { color: var(--primary-color); }

        .hero-card {
            width: 100%; position: relative;
            background: var(--primary-gradient);
            border-radius: 20px; padding: 25px;
            color: white; box-shadow: 0 10px 25px rgba(0, 122, 255, 0.3);
            margin-bottom: 25px; cursor: pointer; overflow: hidden;
            display: flex; align-items: center; justify-content: space-between;
            transition: transform 0.1s; box-sizing: border-box;
        }
        .hero-card:active { transform: scale(0.98); }
        .hero-title { font-size: 22px; font-weight: 800; margin-bottom: 5px; }
        .hero-desc { font-size: 13px; opacity: 0.9; }
        .hero-icon { font-size: 48px; background: rgba(255,255,255,0.2); width: 64px; height: 64px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }

        .section-label { width: 100%; font-size: 14px; font-weight: 600; color: var(--text-sub); margin-bottom: 10px; }
        .modules-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 100%; padding-bottom: 30px; }
        .mini-card {
            background: #F5F7FA; border-radius: 16px; padding: 15px;
            display: flex; flex-direction: column; align-items: flex-start;
            cursor: pointer; height: 100px; justify-content: center;
        }
        .mini-card:active { background: #eee; }
        .mini-icon { font-size: 24px; margin-bottom: 8px; }
        .mini-title { font-size: 15px; font-weight: 700; color: var(--text-main); }
        .mini-desc { font-size: 11px; color: var(--text-sub); }

        /* === 4. å­¦ä¹ ä¸­å¿ƒ (Dashboard) === */
        .dashboard-content { padding: 20px; }
        
        .current-learning-area {
            background: white; border-radius: 16px; padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px;
            text-align: center; cursor: pointer;
        }
        .current-label { font-size: 14px; color: #999; margin-bottom: 15px; letter-spacing: 1px; }
        .current-book-display { display: flex; align-items: center; justify-content: center; gap: 20px; }
        .big-cover {
            width: 80px; height: 110px; border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            color: white; font-weight: bold; font-size: 18px;
            box-shadow: 3px 3px 10px rgba(0,0,0,0.2);
        }
        .current-info { text-align: left; }
        .current-name { font-size: 20px; font-weight: bold; color: #333; margin-bottom: 5px; }
        .current-detail-hint { font-size: 13px; color: var(--primary-color); }

        /* ä¹¦æ¶å…¥å£æŒ‰é’® (æ¢å¤) */
        .bookshelf-entry {
            background: white; border-radius: 12px; padding: 15px 20px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.03); cursor: pointer;
            margin-bottom: 20px;
        }
        .bookshelf-entry:active { background-color: #f5f5f5; }
        .entry-left { display: flex; align-items: center; gap: 10px; font-size: 16px; font-weight: bold; color: #333; }
        .entry-icon { font-size: 20px; }
        .entry-arrow { color: #ccc; }

        /* === 5. ä¹¦æ¶é¡µé¢ (Bookshelf) === */
        .bookshelf-page { padding: 20px; }
        .book-grid-layout { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .book-select-item {
            background: white; border-radius: 16px; padding: 15px;
            display: flex; flex-direction: column; align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.04); cursor: pointer;
            border: 2px solid transparent; position: relative;
        }
        .book-select-item.active { border-color: #007AFF; background: #F5F9FF; }
        .book-cover-small {
            width: 60px; height: 85px; border-radius: 6px; margin-bottom: 10px;
            display: flex; align-items: center; justify-content: center;
            color: white; font-weight: bold; font-size: 14px;
            box-shadow: 2px 4px 10px rgba(0,0,0,0.1);
        }
        .book-item-name { font-size: 15px; font-weight: 700; color: var(--text-main); }
        .active-badge {
            position: absolute; top: 10px; right: 10px; width: 20px; height: 20px;
            background: #007AFF; color: white; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; font-size: 12px;
        }

        /* === 6. ä¹¦ç±è¯¦æƒ…é¡µ (æ— åºå·) === */
        .detail-header { padding: 20px; background: white; text-align: center; border-bottom: 1px solid #f0f0f0; margin-bottom: 10px; flex-shrink: 0; }
        .detail-cover { width: 60px; height: 80px; border-radius: 6px; margin: 0 auto 10px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 14px; box-shadow: 2px 2px 8px rgba(0,0,0,0.15); }
        .detail-title { font-size: 20px; font-weight: bold; color: #333; }
        .detail-count { font-size: 14px; color: #999; margin-top: 5px; }
        .word-list-container { background: #fff; padding-bottom: 20px;}
        .word-list-item { padding: 15px 20px; border-bottom: 1px solid #f5f5f5; display: flex; align-items: center; }
        .list-content { flex: 1; }
        .list-word { font-size: 17px; font-weight: bold; color: #333; margin-bottom: 4px; }
        .list-meaning { font-size: 14px; color: #555; line-height: 1.5; }
        .loading-tip { padding: 40px; text-align: center; color: #999; }

        /* === 7. æŒ‰é’®ä¸äº¤äº’ === */
        .dashboard-actions { padding: 20px; background: white; border-top: 1px solid #eee; display: flex; gap: 15px; margin-top: auto; flex-shrink: 0; z-index: 110;}
        .footer-action { margin-top: auto; padding: 20px; border-top: 1px solid #f0f0f0; background: #fff; position: sticky; bottom: 0; z-index: 90; flex-shrink: 0; }
        .action-btn { flex: 1; padding: 15px; border-radius: 30px; border: none; font-size: 18px; font-weight: 600; cursor: pointer; color: white; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn { display: block; width: 100%; padding: 16px 0; border-radius: 50px; border: none; font-size: 18px; font-weight: 600; cursor: pointer; color: white; text-align: center; transition: all 0.2s; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .btn:active { transform: scale(0.98); }
        .btn-study-start { background: var(--primary-color); box-shadow: 0 4px 10px rgba(74, 144, 226, 0.3); }
        .btn-review-start { background: var(--success-color); box-shadow: 0 4px 10px rgba(46, 204, 113, 0.3); }
        .btn-submit { background: linear-gradient(135deg, #4A90E2 0%, #357ABD 100%); }
        .btn:disabled { background: #ccc; cursor: not-allowed; box-shadow: none; }
        .btn-next { background: linear-gradient(135deg, #2ECC71 0%, #27AE60 100%); }
        .btn-check { background: linear-gradient(135deg, #F39C12 0%, #D35400 100%); }
        .btn-restart { background: var(--primary-color); margin-top: 20px; width: 80%; }

        /* å­¦ä¹ é¡µç»„ä»¶ */
        .progress-bar { height: 4px; background: #f0f0f0; width: 100%; flex-shrink: 0; }
        .progress-fill { height: 100%; background: var(--primary-color); transition: width 0.3s; }
        .progress-text { text-align: center; font-size: 14px; color: #999; margin-top: 10px; flex-shrink: 0; }
        .word-section { padding: 30px 20px 20px; text-align: center; }
        .word-text { font-size: 32px; font-weight: 700; color: var(--text-color); }
        .sentence-text { font-size: 22px; font-weight: 600; color: var(--text-color); line-height: 1.5; min-height: 60px; display: flex; align-items: center; justify-content: center; }
        .image-container-wrapper { position: relative; width: calc(100% - 40px); margin: 0 auto; transition: all 0.3s cubic-bezier(0.25, 0.8, 0.5, 1); overflow: hidden; border-radius: 12px; aspect-ratio: 16 / 9; height: auto; border: 2px dashed #CBD5E0; background-color: #EEF2F7; }
        .image-container-wrapper.is-collapsed { height: 40px !important; aspect-ratio: auto; border-style: solid; background-color: #F0F4F8; cursor: pointer; }
        .image-content { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; color: #A0AEC0; font-size: 14px; position: relative; z-index: 1; }
        .real-image { width: 100%; height: 100%; object-fit: cover; display: block; }
        .is-collapsed .image-content { opacity: 0; pointer-events: none; }
        .ai-controls { position: absolute; top: 8px; left: 8px; display: flex; gap: 8px; z-index: 100; }
        .toggle-btn { position: absolute; top: 8px; right: 8px; background: rgba(0, 0, 0, 0.4); color: white; padding: 4px 10px; border-radius: 12px; font-size: 12px; cursor: pointer; z-index: 100; user-select: none; backdrop-filter: blur(4px); }
        .ai-btn { width: 32px; height: 32px; border-radius: 50%; border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.2); font-size: 16px; transition: transform 0.2s; }
        .btn-refresh { background: white; color: var(--primary-color); }
        .btn-stop { background: var(--stop-color); color: white; }
        .btn-confirm { background: var(--success-color); color: white; }
        .btn-reject { background: var(--error-color); color: white; }
        .expand-hint { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; color: #666; font-size: 13px; font-weight: 500; opacity: 0; pointer-events: none; }
        .is-collapsed .expand-hint { opacity: 1; pointer-events: auto; }
        .is-collapsed .ai-controls { display: none; }
        .ai-loading-mask { position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.8); display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--primary-color); font-weight: bold; font-size: 14px; z-index: 10; }
        .loading-spinner { width: 20px; height: 20px; border: 3px solid #f3f3f3; border-top: 3px solid var(--primary-color); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 8px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .interaction-area { padding: 20px; display: flex; justify-content: center; }
        .input-line { border: none; border-bottom: 2px solid var(--text-color); width: 80%; text-align: center; font-size: 20px; padding: 10px; outline: none; background: transparent; color: var(--text-color); }
        .input-sentence { width: 90%; font-size: 18px; border: 2px solid #E0E0E0; border-radius: 8px; padding: 12px; min-height: 60px; text-align: left; resize: none; font-family: inherit; }
        .input-sentence:focus { border-color: var(--primary-color); outline: none; }
        .filled-card { background-color: #fff; border: 1px solid var(--primary-color); color: var(--primary-color); padding: 12px 24px; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 10px rgba(74, 144, 226, 0.2); animation: pop-in 0.3s; }
        @keyframes pop-in { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        .options-grid { padding: 10px 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .option-card { background: #fff; border: 1px solid #E0E0E0; border-radius: 8px; padding: 15px 10px; text-align: center; cursor: pointer; transition: all 0.2s; font-size: 16px; color: #555; min-height: 40px; display: flex; align-items: center; justify-content: center; }
        .options-disabled .option-card { opacity: 0.4; pointer-events: none; filter: grayscale(1); }
        .option-hidden { visibility: hidden; }

        /* å¼¹çª— */
        .modal-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); display: flex; z-index: 100; animation: fade-in 0.2s; }
        .modal-bottom { align-items: flex-end; }
        .modal-center { justify-content: center; align-items: center; }
        .modal-content-bottom { background: white; width: 100%; border-radius: 20px 20px 0 0; padding: 25px; position: relative; animation: slide-up 0.3s; }
        .modal-content-center { background: white; width: 80%; border-radius: 16px; padding: 30px 20px; text-align: center; animation: pop-in 0.3s; }
        .close-icon { position: absolute; top: 15px; right: 20px; font-size: 24px; color: #999; cursor: pointer; }
        .explanation-title { font-size: 18px; font-weight: bold; margin-bottom: 10px; }
        .explanation-text { color: #666; line-height: 1.6; margin-bottom: 20px; text-align: left;}
        .celebration-overlay { position: absolute; top:0; left:0; width:100%; height:100%; pointer-events: none; display: flex; justify-content: center; align-items: center; z-index: 50; }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.5s; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        .success-text { font-size: 40px; color: var(--success-color); font-weight: bold; text-shadow: 0 2px 10px rgba(255,255,255,0.8); animation: pop-in 0.5s; }
        .result-title { font-size: 24px; font-weight: bold; margin-bottom: 10px; }
        .result-icon { font-size: 60px; margin-bottom: 10px; }
        .test-score-row { display: flex; justify-content: space-around; margin: 20px 0; }
        .score-item { text-align: center; }
        .score-num { font-size: 32px; font-weight: bold; }
        .score-label { font-size: 14px; color: #999; }
        .text-green { color: var(--success-color); }
        .text-red { color: var(--error-color); }
        .switch-book-content { text-align: left; margin: 20px 0; font-size: 15px; color: #555; line-height: 1.8; }
        .switch-btns { display: flex; gap: 15px; }
        .btn-yes { background: var(--primary-color); color: white; border:none; padding:12px; border-radius:25px; flex:1; cursor:pointer; font-weight:bold; font-size:16px;}
        .btn-no { background: #eee; color: #666; border:none; padding:12px; border-radius:25px; flex:1; cursor:pointer; font-weight:bold; font-size:16px;}
        .blank-page { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #999; padding: 30px; text-align: center; }
        .blank-icon { font-size: 60px; margin-bottom: 20px; opacity: 0.5; }
        .shake { animation: shake-animation 0.5s cubic-bezier(.36,.07,.19,.97) both; color: var(--error-color); }
        @keyframes shake-animation { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }
    </style>
</head>
<body>

<div id="app">
    
    <!-- 1. ä¸»é¡µ (Home) -->
    <div v-if="currentPage === 'home'" class="page-container">
        <div class="scroll-wrapper">
            <div class="home-container">
                <div class="app-title">VOCAB <span>MASTER</span></div>
                
                <div class="section-label">æ ¸å¿ƒåŠŸèƒ½</div>
                <!-- Hero Card -->
                <div class="hero-card" @click="goToDashboard">
                    <div class="hero-text">
                        <div class="hero-title">å¼€å§‹èƒŒå•è¯</div>
                        <div class="hero-desc">AI è¾…åŠ©è®°å¿† Â· æ™ºèƒ½å›¾è§£</div>
                    </div>
                    <div class="hero-icon">ğŸ“š</div>
                </div>

                <div class="section-label" style="margin-top:20px;">ä¸“é¡¹è®­ç»ƒ</div>
                <div class="modules-grid">
                    <div class="mini-card" @click="goToTest"><div class="mini-icon">ğŸ“</div><div class="mini-title">è¯æ±‡è‡ªæµ‹</div><div class="mini-desc">é¢˜åº“æ··åˆæµ‹è¯•</div></div>
                    <div class="mini-card" @click="goToSentence"><div class="mini-icon">âœï¸</div><div class="mini-title">é€ å¥ç»ƒä¹ </div><div class="mini-desc">AI çº æ­£è¯­æ³•</div></div>
                    <div class="mini-card" @click="showComingSoon('å†™ä½œç»ƒä¹ ')"><div class="mini-icon">ğŸ–‹ï¸</div><div class="mini-title">å†™ä½œç»ƒä¹ </div><div class="mini-desc">ä¸»é¢˜å†™ä½œæ¶¦è‰²</div></div>
                    <div class="mini-card" @click="showComingSoon('å£è¯­ç»ƒä¹ ')"><div class="mini-icon">ğŸ™ï¸</div><div class="mini-title">å£è¯­ç»ƒä¹ </div><div class="mini-desc">æ¨¡æ‹Ÿå¯¹è¯</div></div>
                </div>
            </div>
        </div>
    </div>

    <!-- 2. å­¦ä¹ ä»ªè¡¨ç›˜ (Study Dashboard) -->
    <div v-else-if="currentPage === 'study-dashboard'" class="page-container">
        <div class="header-bar"><button class="btn-back" @click="goHome"><span>â® è¿”å›ä¸»é¡µ</span></button><div class="page-title">å­¦ä¹ ä¸­å¿ƒ</div></div>
        
        <div class="scroll-wrapper">
            <div class="dashboard-content">
                <!-- é¡¶éƒ¨ï¼šæ­£åœ¨å­¦ä¹ å¡ç‰‡ -->
                <div class="current-learning-area" @click="goToBookDetail(currentBookObject)">
                    <div class="current-label">â€”â€” æ­£åœ¨å­¦ä¹  â€”â€”</div>
                    <div class="current-book-display">
                        <div class="big-cover" :style="{ background: currentBookObject.color }">{{ currentBookObject.shortName }}</div>
                        <div class="current-info"><div class="current-name">{{ currentBookObject.name }}</div><div class="current-detail-hint">ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ… ></div></div>
                    </div>
                </div>

                <!-- ä¹¦æ¶å…¥å£ -->
                <div class="bookshelf-entry" @click="goToBookshelfPage">
                    <div class="entry-left"><div class="entry-icon">ğŸ“š</div><div>æˆ‘çš„ä¹¦æ¶</div></div><div class="entry-arrow">â¯</div>
                </div>
            </div>
        </div>

        <div class="dashboard-actions">
            <button class="action-btn btn-study-start" @click="startRealStudy"><span>ğŸ“–</span> å¼€å§‹å­¦ä¹ </button>
            <button class="action-btn btn-review-start" @click="goToReview"><span>ğŸ”„</span> å¼€å§‹å¤ä¹ </button>
        </div>
    </div>

    <!-- 2.5 ç‹¬ç«‹ä¹¦æ¶é¡µé¢ (Bookshelf Page) -->
    <div v-else-if="currentPage === 'bookshelf'" class="page-container">
        <div class="header-bar"><button class="btn-back" @click="goToDashboard"><span>â® è¿”å›å­¦ä¹ </span></button><div class="page-title">æˆ‘çš„ä¹¦æ¶</div></div>
        <div class="scroll-wrapper">
            <div class="bookshelf-page">
                <div class="book-grid-layout">
                    <div v-for="book in books" :key="book.id" class="book-select-item" :class="{ active: currentBookId === book.id }" @click="onBookClickInBookshelf(book)">
                        <div class="book-cover-small" :style="{ background: book.color }">{{ book.shortName }}</div>
                        <div class="book-item-name">{{ book.name }}</div>
                        <div v-if="currentBookId === book.id" class="active-badge">âœ”</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 2.1 ä¹¦ç±è¯¦æƒ…é¡µ (æ— åºå·åˆ—è¡¨) -->
    <div v-else-if="currentPage === 'book-detail'" class="page-container">
        <div class="header-bar"><button class="btn-back" @click="goToDashboard"><span>â® è¿”å›ä¹¦æ¶</span></button><div class="page-title">ä¹¦ç±è¯¦æƒ…</div></div>
        
        <div class="scroll-wrapper">
            <div class="detail-header">
                <div class="detail-cover" :style="{ background: getBookById(currentDetailBookId).color }">
                    {{ getBookById(currentDetailBookId).shortName }}
                </div>
                <div class="detail-title">{{ getBookName(currentDetailBookId) }}</div>
                <div class="detail-count" v-if="detailBookWords.length > 0">å…± {{ detailBookWords.length }} ä¸ªå•è¯</div>
            </div>

            <div class="word-list-container">
                <div v-if="isDetailLoading" class="loading-tip">æ­£åœ¨åŠ è½½å•è¯åˆ—è¡¨...</div>
                <div v-else>
                    <div class="word-list-item" v-for="item in detailBookWords" :key="item.id">
                        <div class="list-content">
                            <div class="list-word">{{ item.word }}</div>
                            <div class="list-meaning">{{ item.exp }}</div>
                        </div>
                    </div>
                    <div v-if="detailBookWords.length === 0" style="padding:40px; text-align:center; color:#999;">æš‚æ— å•è¯æ•°æ®</div>
                </div>
            </div>
        </div>
    </div>

    <!-- 2.2 å¤ä¹ é¡µ (å ä½) -->
    <div v-else-if="currentPage === 'review'" class="page-container">
        <div class="header-bar"><button class="btn-back" @click="goToDashboard"><span>â® è¿”å›ä¹¦æ¶</span></button><div class="page-title">å•è¯å¤ä¹ </div></div>
        <div class="scroll-wrapper"><div class="blank-page"><div class="blank-icon">ğŸ§ </div><h3>å¤ä¹ æ¨¡å¼</h3><p>è¿™é‡Œå°†æ ¹æ®è‰¾å®¾æµ©æ–¯è®°å¿†æ›²çº¿å®‰æ’å¤ä¹ å†…å®¹ã€‚</p></div></div>
    </div>

    <!-- 3. æ­£å¼å­¦ä¹ é¡µé¢ (Study) -->
    <div v-else-if="currentPage === 'study'" class="page-container">
        <div class="header-bar"><button class="btn-back" @click="goToDashboard"><span>â® é€€å‡ºå­¦ä¹ </span></button><div class="page-title">{{ getBookName(currentBookId) }}</div></div>
        <div class="progress-bar"><div class="progress-fill" :style="{ width: ((currentIndex + 1) / roundTotal) * 100 + '%' }"></div></div>
        <div class="progress-text">æœ¬è½®è¿›åº¦ï¼š{{ currentIndex + 1 }} / {{ roundTotal }}</div>
        
        <div class="scroll-wrapper">
            <div class="word-section" v-if="currentQuestion"><div class="word-text" :class="{ 'shake': isError }">{{ currentQuestion.word }}</div></div>
            <div class="image-container-wrapper" :class="{ 'is-collapsed': isImageCollapsed }" @click="isImageCollapsed ? toggleImage() : null">
                <div class="ai-controls" @click.stop>
                    <button v-if="isGeneratingAI" class="ai-btn btn-stop" @click.stop="stopAI" title="åœæ­¢">â¹</button>
                    <button v-else-if="!aiReviewMode" class="ai-btn btn-refresh" @click="generateAIImage('word')" title="AIç”Ÿå›¾">ğŸ”„</button>
                    <button v-if="aiReviewMode" class="ai-btn btn-confirm" @click="confirmAIImage" title="ä¿ç•™">âˆš</button>
                    <button v-if="aiReviewMode" class="ai-btn btn-reject" @click="rejectAIImage" title="è¿˜åŸ">Ã—</button>
                </div>
                <div class="toggle-btn" @click.stop="toggleImage">{{ isImageCollapsed ? 'å±•å¼€ ğŸ”½' : 'æŠ˜å  ğŸ”¼' }}</div>
                <div class="image-content">
                    <div v-if="isGeneratingAI" class="ai-loading-mask"><div class="loading-spinner"></div><span>AI ç»˜å›¾ä¸­...</span></div>
                    <img v-if="currentDisplayImage" :src="currentDisplayImage" class="real-image" @error="handleImgError" />
                    <span v-else>æš‚æ— å›¾ç‰‡</span>
                </div>
                <div class="expand-hint">ç‚¹å‡»å±•å¼€å›¾ç‰‡</div>
            </div>
            <div class="interaction-area">
                <div v-if="selectedOption" class="filled-card" @click="cancelSelection">{{ selectedOption.text }}</div>
                <input v-else type="text" class="input-line" v-model="inputValue" placeholder="ç‚¹å‡»è¾“å…¥ä¸­æ–‡" @input="handleInput" :disabled="status !== 'answering' || isCheckingAnswer">
            </div>
            <div class="options-grid" :class="{ 'options-disabled': hasInputText || isCheckingAnswer || status !== 'answering' }">
                <div v-for="(opt, index) in currentQuestion?.options" :key="index" class="option-card" :class="{ 'option-hidden': selectedOption && selectedOption.id === opt.id }" @click="selectOption(opt)">{{ opt.text }}</div>
            </div>
        </div>

        <div class="footer-action" v-if="showFooterBtn">
            <button v-if="status === 'answering'" class="btn btn-submit" @click="submitAnswer" :disabled="isCheckingAnswer">{{ isCheckingAnswer ? 'AI æ­£åœ¨åˆ¤æ–­...' : 'æäº¤ç­”æ¡ˆ' }}</button>
            <button v-else-if="status === 'correct'" class="btn btn-check" @click="openAiSuccessModal">æŸ¥çœ‹è§£æ</button>
            <button v-else-if="status === 'wrong'" class="btn btn-check" @click="openExplanation">æŸ¥çœ‹è§£æ</button>
        </div>
    </div>

    <!-- 4. è¯æ±‡è‡ªæµ‹é¡µé¢ -->
    <div v-else-if="currentPage === 'test'" class="page-container">
        <div class="header-bar"><button class="btn-back" @click="goHome"><span>â® è¿”å›ä¸»é¡µ</span></button><div class="page-title">è¯æ±‡è‡ªæµ‹</div></div>
        <div class="progress-bar"><div class="progress-fill" :style="{ width: ((currentIndex + 1) / roundTotal) * 100 + '%' }"></div></div>
        <div class="progress-text">æµ‹è¯•è¿›åº¦ï¼š{{ currentIndex + 1 }} / {{ roundTotal }}</div>
        
        <div class="scroll-wrapper">
            <div class="word-section" v-if="currentQuestion"><div class="word-text" :class="{ 'shake': isError }">{{ currentQuestion.word }}</div></div>
            <div style="flex: 0.5;"></div>
            <div class="interaction-area">
                <div v-if="selectedOption" class="filled-card" @click="cancelSelection">{{ selectedOption.text }}</div>
                <input v-else type="text" class="input-line" v-model="inputValue" placeholder="ç‚¹å‡»è¾“å…¥ä¸­æ–‡" @input="handleInput" :disabled="status !== 'answering'">
            </div>
            <div class="options-grid" :class="{ 'options-disabled': hasInputText || status !== 'answering' }">
                <div v-for="(opt, index) in currentQuestion?.options" :key="index" class="option-card" :class="{ 'option-hidden': selectedOption && selectedOption.id === opt.id }" @click="selectOption(opt)">{{ opt.text }}</div>
            </div>
        </div>

        <div class="footer-action" v-if="showFooterBtn">
            <button v-if="status === 'answering'" class="btn btn-submit" @click="submitAnswer">æäº¤ç­”æ¡ˆ</button>
            <button v-else class="btn btn-next" @click="nextQuestion">ä¸‹ä¸€é¢˜</button>
        </div>
    </div>

    <!-- 5. é€ å¥ç»ƒä¹ é¡µé¢ -->
    <div v-else-if="currentPage === 'sentence'" class="page-container">
        <div class="header-bar"><button class="btn-back" @click="goHome"><span>â® è¿”å›ä¸»é¡µ</span></button><div class="page-title">é€ å¥ç»ƒä¹ </div></div>
        <div class="progress-bar"><div class="progress-fill" :style="{ width: ((currentIndex + 1) / roundTotal) * 100 + '%' }"></div></div>
        <div class="progress-text">æœ¬è½®è¿›åº¦ï¼š{{ currentIndex + 1 }} / {{ roundTotal }}</div>
        
        <div class="scroll-wrapper">
            <div class="word-section"><div v-if="currentSentence" class="sentence-text">{{ currentSentence.chinese }}</div><div v-else style="color: red; padding: 20px;">âš ï¸ é¢˜åº“åŠ è½½å¤±è´¥</div></div>
            <div class="image-container-wrapper" :class="{ 'is-collapsed': isImageCollapsed }" @click="isImageCollapsed ? toggleImage() : null">
                <div class="ai-controls" @click.stop>
                    <button v-if="isGeneratingAI" class="ai-btn btn-stop" @click.stop="stopAI" title="åœæ­¢">â¹</button>
                    <button v-else-if="!aiReviewMode" class="ai-btn btn-refresh" @click="generateAIImage('sentence')" title="ç”Ÿå›¾">ğŸ”„</button>
                    <button v-if="aiReviewMode" class="ai-btn btn-confirm" @click="confirmAIImage" title="ä¿ç•™">âˆš</button>
                    <button v-if="aiReviewMode" class="ai-btn btn-reject" @click="rejectAIImage" title="è¿˜åŸ">Ã—</button>
                </div>
                <div class="toggle-btn" @click.stop="toggleImage">{{ isImageCollapsed ? 'å±•å¼€ ğŸ”½' : 'æŠ˜å  ğŸ”¼' }}</div>
                <div class="image-content">
                    <div v-if="isGeneratingAI" class="ai-loading-mask"><div class="loading-spinner"></div><span>AI ç»˜å›¾ä¸­...</span></div>
                    <img v-if="currentDisplayImage" :src="currentDisplayImage" class="real-image" @error="handleImgError" />
                    <span v-else>æš‚æ— å›¾ç‰‡</span>
                </div>
                <div class="expand-hint">ç‚¹å‡»å±•å¼€å›¾ç‰‡</div>
            </div>
            <div class="interaction-area">
                <textarea class="input-line input-sentence" v-model="inputValue" placeholder="è¯·è¾“å…¥è‹±æ–‡å¥å­..." @input="handleInput" :disabled="status !== 'answering' || isCheckingAnswer"></textarea>
            </div>
        </div>

        <div class="footer-action" v-if="hasInputText || status !== 'answering'">
            <button v-if="status === 'answering'" class="btn btn-submit" @click="submitSentence" :disabled="isCheckingAnswer">{{ isCheckingAnswer ? 'AI æ‰¹æ”¹ä¸­...' : 'æäº¤ç­”æ¡ˆ' }}</button>
            <button v-else class="btn btn-next" @click="nextSentence">ä¸‹ä¸€é¢˜</button>
        </div>
    </div>

    <!-- å¼¹çª—ï¼šåˆ‡æ¢ä¹¦ç¡®è®¤ -->
    <div class="modal-overlay modal-center" v-if="showSwitchBookModal">
        <div class="modal-content-center">
            <div class="result-icon">ğŸ“–</div>
            <div class="result-title" style="font-size:18px;">ç¡®è®¤åˆ‡æ¢å•è¯ä¹¦ï¼Ÿ</div>
            <div class="switch-book-content">
                <p>å½“å‰æ­£åœ¨å­¦ä¹ ï¼š<strong style="color:var(--primary-color)">{{ getBookName(currentBookId) }}</strong></p>
                <p>æ˜¯å¦è¦æ›´æ¢ä¸ºï¼š<strong style="color:var(--success-color)">{{ getBookName(pendingBookId) }}</strong></p>
            </div>
            <div class="switch-btns">
                <button class="btn-yes" @click="confirmSwitchBook">æ˜¯</button>
                <button class="btn-no" @click="cancelSwitchBook">å¦</button>
            </div>
        </div>
    </div>

    <!-- é€šç”¨æç¤ºå¼¹çª— -->
    <div class="modal-overlay modal-center" v-if="showComingSoonModal">
        <div class="modal-content-center"><div class="result-icon">ğŸš§</div><div class="result-title">{{ comingSoonTitle }}</div><p style="color:#666;">åŠŸèƒ½å¼€å‘ä¸­...</p><button class="btn btn-restart" @click="showComingSoonModal = false">å…³é—­</button></div>
    </div>

    <!-- å…¶ä»–åŸæœ‰å¼¹çª— -->
    <transition name="fade"><div class="celebration-overlay" v-if="showCelebration"><div class="success-text">ğŸ‰ Excellent!</div></div></transition>
    <div class="modal-overlay modal-bottom" v-if="showExplainModal">
        <div class="modal-content-bottom"><div class="close-icon" @click="closeExplainModal">Ã—</div><div class="explanation-title">å›ç­”é”™è¯¯</div><div class="explanation-text"><p><strong>æ­£ç¡®æ„æ€ï¼š</strong>{{ currentQuestion?.answerText }}</p><p>{{ currentQuestion?.explanation }}</p></div><button class="btn btn-next" @click="nextQuestionFromModal">ä¸‹ä¸€é¢˜</button></div>
    </div>
    <div class="modal-overlay modal-bottom" v-if="showAiSuccessModal">
        <div class="modal-content-bottom"><div class="close-icon" @click="closeAiSuccessModal">Ã—</div><div class="explanation-title" style="color: var(--success-color)">å›ç­”æ­£ç¡®</div><div class="explanation-text"><p><strong>AI è§£æï¼š</strong></p><p style="background: #f0f9eb; padding: 10px; border-radius: 8px;">{{ aiExplanationText }}</p></div><button class="btn btn-next" @click="nextQuestionFromAiModal">ä¸‹ä¸€é¢˜</button></div>
    </div>
    <div class="modal-overlay modal-bottom" v-if="showSentenceResultModal">
        <div class="modal-content-bottom"><div class="close-icon" @click="closeSentenceResultModal">Ã—</div><div class="explanation-title" :style="{color: isSentenceCorrect ? 'var(--success-color)' : 'var(--error-color)'}">{{ isSentenceCorrect ? 'å›ç­”æ­£ç¡®' : 'éœ€è¦æ”¹è¿›' }}</div><div class="explanation-text"><p><strong>AI ç‚¹è¯„ï¼š</strong>{{ sentenceFeedback }}</p><div v-if="sentenceBetterVersion" style="margin-top:10px; background:#f5f7fa; padding:10px; border-radius:8px;"><p style="margin:0; font-weight:bold; font-size:12px; color:#999;">å‚è€ƒç­”æ¡ˆï¼š</p><p style="margin:5px 0 0 0;">{{ sentenceBetterVersion }}</p></div></div><button class="btn btn-next" @click="nextSentenceFromModal">ä¸‹ä¸€é¢˜</button></div>
    </div>
    <div class="modal-overlay modal-center" v-if="showResultModal">
        <div class="modal-content-center"><div class="result-icon">ğŸ†</div><div class="result-title">ç»ƒä¹ ç»“æŸ</div><button class="btn btn-restart" @click="restartGame">é‡æ–°å¼€å§‹</button></div>
    </div>
    <div class="modal-overlay modal-center" v-if="showTestResultModal">
        <div class="modal-content-center"><div class="close-icon" @click="closeTestResultModal">Ã—</div><div class="result-icon">ğŸ“</div><div class="result-title">æµ‹è¯•ç»“æœ</div><div class="test-score-row"><div class="score-item"><div class="score-num text-green">{{ testCorrectCount }}</div><div class="score-label">æ­£ç¡®</div></div><div class="score-item"><div class="score-num text-red">{{ testWrongCount }}</div><div class="score-label">é”™è¯¯</div></div></div><button class="btn btn-restart" @click="goHome">è¿”å›ä¸»é¡µ</button></div>
    </div>
</div>

<script>
    const { createApp } = Vue;
    // è®°å¾—ä¿®æ”¹ API åœ°å€
    const API_BASE = "https://my-vocab-backend.onrender.com/api";

    createApp({
        data() {
            return {
                currentPage: 'home', 
                roundTotal: 5, currentRoundList: [], currentIndex: 0, usedQuestionIds: [],
                
                books: [], 
                imageLibrary: {}, aiImageSaveLibrary: {},
                currentBookId: 'cet4', currentDetailBookId: '',
                
                detailBookWords: [], isDetailLoading: false,
                showSwitchBookModal: false, pendingBookId: '',
                showComingSoonModal: false, comingSoonTitle: '',

                inputValue: "", selectedOption: null, status: 'answering', 
                showExplainModal: false, showResultModal: false, showCelebration: false, isError: false, isImageCollapsed: false,
                isGeneratingAI: false, aiReviewMode: false, tempAIImage: "", currentRequestId: 0,
                isCheckingAnswer: false, showAiSuccessModal: false, aiExplanationText: "", lastUserInput: "",
                testCorrectCount: 0, testWrongCount: 0, showTestResultModal: false,
                showSentenceResultModal: false, isSentenceCorrect: false, sentenceFeedback: "", sentenceBetterVersion: ""
            };
        },
        async mounted() {
            try {
                const res = await fetch(`${API_BASE}/books`);
                this.books = await res.json();
                if (this.books.length > 0 && !this.books.find(b => b.id === this.currentBookId)) {
                    this.currentBookId = this.books[0].id;
                }
            } catch(e) { console.error("API Error", e); }
            
            if (window.IMAGE_LIBRARY) this.imageLibrary = window.IMAGE_LIBRARY;
            const saved = localStorage.getItem('ai_image_save');
            if (saved) { try { this.aiImageSaveLibrary = JSON.parse(saved); } catch(e) {} }
        },
        computed: {
            currentBookObject() { return this.books.find(b => b.id === this.currentBookId) || {}; },
            currentQuestion() { 
                if (this.currentPage === 'study' || this.currentPage === 'test') return this.currentRoundList[this.currentIndex] || null;
                return null;
            },
            currentSentence() {
                if (this.currentPage === 'sentence') return this.currentRoundList[this.currentIndex] || null;
                return null;
            },
            currentDisplayImage() {
                if (this.aiReviewMode && this.tempAIImage) return this.tempAIImage;
                if (this.currentPage === 'sentence' && this.currentSentence) {
                    return this.aiImageSaveLibrary['sentence_' + this.currentSentence.id] || "";
                }
                if (this.currentQuestion) return this.currentQuestion.imgUrl;
                return "";
            },
            hasInputText() { return this.inputValue.trim().length > 0; },
            showFooterBtn() {
                if (this.status !== 'answering') return true;
                return this.hasInputText || this.selectedOption !== null;
            }
        },
        methods: {
            goToDashboard() { this.stopAI(); this.currentPage = 'study-dashboard'; },
            goToTest() { this.currentPage = 'test'; this.roundTotal=15; this.startNewTest(); },
            goToSentence() { this.currentPage = 'sentence'; this.roundTotal=5; this.startNewSentenceRound(); },
            goHome() { this.stopAI(); this.showTestResultModal = false; this.currentPage = 'home'; },
            showComingSoon(t) { this.comingSoonTitle=t; this.showComingSoonModal=true; },
            
            goToBookshelfPage() { this.currentPage = 'bookshelf'; },

            // ä¹¦æ¶é€»è¾‘ï¼šç‚¹å‡» -> å¼¹çª—ç¡®è®¤
            onBookClickInBookshelf(book) {
                if (book.id === this.currentBookId) {
                    this.goToDashboard(); // å·²ç»æ˜¯å½“å‰ä¹¦ï¼Œç›´æ¥å›ä»ªè¡¨ç›˜
                    return;
                }
                this.pendingBookId = book.id;
                this.showSwitchBookModal = true;
            },
            confirmSwitchBook() { 
                this.currentBookId = this.pendingBookId; 
                this.showSwitchBookModal = false; 
                this.pendingBookId = ''; 
                this.goToDashboard(); // åˆ‡æ¢åè·³å›ä»ªè¡¨ç›˜
            },
            cancelSwitchBook() { 
                this.showSwitchBookModal = false; 
                this.pendingBookId = ''; 
            },

            async goToBookDetail(book) { 
                this.currentDetailBookId = book.id; 
                this.currentPage = 'book-detail';
                this.isDetailLoading = true;
                this.detailBookWords = [];
                try {
                    const res = await fetch(`${API_BASE}/book_words?book_id=${book.id}`);
                    this.detailBookWords = await res.json();
                } catch(e) { alert("åŠ è½½å¤±è´¥"); } 
                finally { this.isDetailLoading = false; }
            },
            
            getBookById(id) { return this.books.find(b => b.id === id) || {}; },
            getBookName(id) { return this.getBookById(id).name || 'æœªçŸ¥è¯ä¹¦'; },

            goToReview() { this.currentPage = 'review'; },
            startRealStudy() { this.currentPage = 'study'; this.roundTotal=5; this.startNewRound(); },
            
            async startNewRound() {
                try {
                    const res = await fetch(`${API_BASE}/book_words?book_id=${this.currentBookId}`);
                    let words = await res.json();
                    if (!words || words.length === 0) { alert("è¯¥é¢˜åº“æš‚æ— æ•°æ®"); return; }
                    
                    const newRound = [];
                    for(let i=0; i<this.roundTotal; i++) {
                        const r = Math.floor(Math.random() * words.length);
                        newRound.push(this.formatQuestion(words[r]));
                    }
                    this.currentRoundList = newRound; this.currentIndex=0; this.resetInteractionState(); this.showResultModal=false;
                } catch(e){ alert("ç½‘ç»œé”™è¯¯"); }
            },

            async startNewTest() {
                this.testCorrectCount=0; this.testWrongCount=0;
                try {
                    const res = await fetch(`${API_BASE}/book_words?book_id=all_test`);
                    const data = await res.json();
                    this.currentRoundList = data.map(q => this.formatQuestion(q));
                    this.currentIndex=0; this.roundTotal=data.length; this.resetInteractionState(); this.showTestResultModal=false;
                } catch(e){ alert("åŠ è½½æµ‹è¯•å¤±è´¥"); }
            },

            async startNewSentenceRound() {
                try {
                    const res = await fetch(`${API_BASE}/sentences`);
                    const data = await res.json();
                    this.currentRoundList = data.sort(()=>0.5-Math.random()).slice(0,this.roundTotal);
                    this.currentIndex=0; this.resetInteractionState(); this.showResultModal=false;
                } catch(e){ alert("åŠ è½½é€ å¥å¤±è´¥"); }
            },

            formatQuestion(raw) {
                const shuffled = [...raw.options].sort(() => 0.5 - Math.random());
                let img = this.imageLibrary[raw.word] || "";
                if (this.aiImageSaveLibrary[raw.word]) img = this.aiImageSaveLibrary[raw.word];
                return { ...raw, imgUrl: img, options: shuffled.map((txt, idx) => ({ id: idx, text: txt, isCorrect: txt.includes(raw.answer) })) };
            },
            
            async generateAIImage(type) {
                if(this.isGeneratingAI) return;
                this.isGeneratingAI=true; this.currentRequestId++; const reqId = this.currentRequestId;
                
                let prompt = "";
                if(type==='sentence') prompt = `illustration of "${this.currentSentence.chinese}", educational`;
                else prompt = `cartoon illustration of ${this.currentQuestion.word}, simple vector art`;
                
                const url = `https://image.pollinations.ai/prompt/${encodeURIComponent(prompt)}?width=800&height=450&n=${Math.random()}`;
                
                const img = new Image();
                img.onload = () => {
                    if(this.currentRequestId === reqId) { this.tempAIImage=url; this.aiReviewMode=true; this.isGeneratingAI=false; }
                };
                img.src = url;
            },
            confirmAIImage() {
                const url = this.tempAIImage;
                if(this.currentPage==='sentence') {
                    this.aiImageSaveLibrary['sentence_'+this.currentSentence.id] = url;
                } else {
                    this.currentQuestion.imgUrl = url;
                    this.aiImageSaveLibrary[this.currentQuestion.word] = url;
                }
                localStorage.setItem('ai_image_save', JSON.stringify(this.aiImageSaveLibrary));
                this.aiReviewMode=false; this.tempAIImage="";
            },
            rejectAIImage() { this.aiReviewMode=false; this.tempAIImage=""; },
            stopAI() { this.currentRequestId++; this.isGeneratingAI=false; this.aiReviewMode=false; },
            handleImgError(e) { e.target.style.display='none'; },

            resetInteractionState() {
                this.inputValue=""; this.selectedOption=null; this.status='answering';
                this.isError=false; this.showExplainModal=false; this.showCelebration=false;
                this.isCheckingAnswer=false; this.stopAI();
            },
            toggleImage() { this.isImageCollapsed = !this.isImageCollapsed; },
            handleInput() { if(this.inputValue) this.selectedOption=null; },
            selectOption(opt) {
                if(this.status!=='answering' || this.isCheckingAnswer) return;
                if(this.inputValue) return;
                this.selectedOption = opt;
            },
            cancelSelection() { if(this.status==='answering' && !this.isCheckingAnswer) this.selectedOption=null; },

            async submitAnswer() {
                if(this.selectedOption) {
                    if(this.selectedOption.isCorrect) this.handleCorrect();
                    else this.handleWrong();
                    return;
                }
                if(this.inputValue) {
                    if(this.currentPage==='test') {
                        if(this.inputValue.includes(this.currentQuestion.answer)) this.handleCorrect();
                        else this.handleWrong();
                        return;
                    }
                    this.isCheckingAnswer = true;
                    try {
                        const res = await fetch(`${API_BASE}/check_answer`, {
                            method:'POST', headers:{'Content-Type':'application/json'},
                            body:JSON.stringify({word:this.currentQuestion.word, user_input:this.inputValue})
                        });
                        const data = await res.json();
                        this.isCheckingAnswer = false;
                        if(data.is_correct) {
                            this.aiExplanationText = data.explanation;
                            this.handleCorrect(true);
                        } else {
                            this.handleWrong();
                        }
                    } catch(e) { this.isCheckingAnswer=false; alert("AI Error"); }
                }
            },
            async submitSentence() {
                if(!this.inputValue) return;
                this.isCheckingAnswer=true;
                try {
                    const res = await fetch(`${API_BASE}/check_sentence`, {
                        method:'POST', headers:{'Content-Type':'application/json'},
                        body:JSON.stringify({question:this.currentSentence.chinese, user_input:this.inputValue})
                    });
                    const data = await res.json();
                    this.isCheckingAnswer=false;
                    this.isSentenceCorrect = data.is_correct;
                    this.sentenceFeedback = data.feedback;
                    this.sentenceBetterVersion = data.better_version;
                    
                    if(data.is_correct) { 
                        this.status='correct'; this.showCelebration=true; 
                        setTimeout(()=>this.showCelebration=false, 1500);
                    } else {
                        this.status='wrong'; this.isError=true;
                        setTimeout(()=>this.isError=false, 500);
                    }
                    this.showSentenceResultModal = true;
                } catch(e) { this.isCheckingAnswer=false; alert("AI Error"); }
            },

            handleCorrect(ai=false) {
                this.status='correct'; this.showCelebration=true;
                setTimeout(()=>this.showCelebration=false, 1500);
                if(this.currentPage==='test') this.testCorrectCount++;
                else if(ai) this.showAiSuccessModal=true;
            },
            handleWrong() {
                this.status='wrong'; this.isError=true;
                setTimeout(()=>this.isError=false, 500);
                if(this.currentPage==='test') this.testWrongCount++;
            },

            nextQuestion() { this.checkRound(); },
            nextQuestionFromModal() { this.showExplainModal=false; this.checkRound(); },
            nextQuestionFromAiModal() { this.showAiSuccessModal=false; this.checkRound(); },
            openExplainModal() { this.showExplainModal=true; },

            nextSentence() { this.checkRound(); },
            nextSentenceFromModal() { this.showSentenceResultModal=false; this.checkRound(); },

            checkRound() {
                if(this.currentIndex < this.roundTotal-1) {
                    this.currentIndex++; this.resetInteractionState();
                } else {
                    if(this.currentPage==='test') this.showTestResultModal=true;
                    else this.showResultModal=true;
                }
            },
            restartGame() {
                if(this.currentPage==='sentence') this.startNewSentenceRound();
                else this.startNewRound();
            }
        }
    }).mount('#app');
</script>

</body>
</html>